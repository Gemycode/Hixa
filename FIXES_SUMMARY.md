# ููุฎุต ุงูุฅุตูุงุญุงุช ุงูููุฌุฒุฉ

## โ ุชู ุฅููุงู ุงูููุงูุต ุงูุชุงููุฉ:

### 1. Routes ููุฑุณุงุฆู (messageRoutes.js)
- โ ุฅุถุงูุฉ ุฌููุน ุงููุณุงุฑุงุช ุงููุทููุจุฉ:
  - `POST /` - ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
  - `GET /room/:roomId` - ุฌูุจ ุฑุณุงุฆู ุงูุบุฑูุฉ
  - `PATCH /:messageId/read` - ุชุญุฏูุฏ ุงูุฑุณุงูุฉ ูููุฑูุกุฉ
  - `GET /unread/count` - ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
  - `PUT /:messageId` - ุชุนุฏูู ุฑุณุงูุฉ
  - `DELETE /:messageId` - ุญุฐู ุฑุณุงูุฉ
  - `POST /:messageId/reaction` - ุฅุถุงูุฉ/ุฅุฒุงูุฉ ุชูุงุนู
  - `GET /search` - ุงูุจุญุซ ูู ุงูุฑุณุงุฆู

### 2. ูููุฐุฌ ุงูุฑุณุงุฆู (messageModel.js)
- โ ุฅุถุงูุฉ `replyTo` ููุฑุฏูุฏ
- โ ุฅุถุงูุฉ `reactions` ููุชูุงุนูุงุช
- โ ุฅุถุงูุฉ `isEdited` ู `isDeleted` ู `deletedAt` ู `deletedBy`
- โ ุชุญุฏูุซ `content` ููููู optional ุนูุฏ ูุฌูุฏ ูุฑููุงุช
- โ ุฅุถุงูุฉ ููุงุฑุณ ููุฃุฏุงุก
- โ ุฅุถุงูุฉ pre-save hook ูุชุญุฏูุซ `isEdited`

### 3. Controller ููุฑุณุงุฆู (messageController.js)
- โ ุฅุถุงูุฉ `updateMessage` - ุชุนุฏูู ุงูุฑุณุงุฆู
- โ ุฅุถุงูุฉ `deleteMessage` - ุญุฐู ุงูุฑุณุงุฆู (soft delete)
- โ ุฅุถุงูุฉ `toggleReaction` - ุฅุถุงูุฉ/ุฅุฒุงูุฉ ุงูุชูุงุนูุงุช
- โ ุฅุถุงูุฉ `searchMessages` - ุงูุจุญุซ ูู ุงูุฑุณุงุฆู
- โ ุฅุตูุงุญ `execPopulate` (ุงุณุชุจุฏุงูู ุจู `populate` array)
- โ ุชุญุฏูุซ `getMessagesByRoom` ูุฏุนู populate ููุฑุฏูุฏ ูุงูุชูุงุนูุงุช
- โ ุชุญุฏูุซ `getUnreadMessagesCount` ูุงุณุชุจุนุงุฏ ุงูุฑุณุงุฆู ุงููุญุฐููุฉ ูุงููููุฑูุกุฉ
- โ ุฅุตูุงุญ ุฑูุน ุงููููุงุช ูุงุณุชุฎุฏุงู buffer ุจุฏูุงู ูู path

### 4. WebSocket Server (websocket/websocket.js)
- โ ุฅุถุงูุฉ ูุธุงู ุชุชุจุน ุงูุบุฑู (`roomMembers`, `userRooms`)
- โ ุชูููุฐ `broadcastToRoom` ุจุดูู ูุงูู
- โ ุฅุถุงูุฉ `joinRoom` ู `leaveRoom`
- โ ุชุญุฏูุซ `handleTyping` ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงููุชุงุจุฉ
- โ ุชุญุฏูุซ `handleReadReceipt` ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงููุฑุงุกุฉ
- โ ุฅุถุงูุฉ ูุนุงูุฌุฉ `join_room` ู `leave_room` ูู handleMessage
- โ ุฅุถุงูุฉ `getWebSocketServer` ู `initWebSocketServer` ูู singleton
- โ ุชูุธูู ุงูุงุชุตุงูุงุช ุนูุฏ ุงูุฅุบูุงู

### 5. ุฅุตูุงุญุงุช ุฅุถุงููุฉ
- โ ุชุญุฏูุซ `app.js` ูุงุณุชุฎุฏุงู `initWebSocketServer`
- โ ุชุญุฏูุซ `routes/messageRoutes.js` ูุงุณุชุฎุฏุงู `uploadMultiple` ูู middleware
- โ ุฅุฒุงูุฉ ุงูุงุนุชูุงุฏ ุนูู `utils/cloudinary` ูุงุณุชุฎุฏุงู `middleware/upload` ุจุฏูุงู ููู

---

## ๐ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ุงููุถุงูุฉ:

1. **ุชุนุฏูู ุงูุฑุณุงุฆู**: ูููู ูููุณุชุฎุฏููู ุชุนุฏูู ุฑุณุงุฆููู
2. **ุญุฐู ุงูุฑุณุงุฆู**: ุญุฐู ูุงุนู (soft delete) ููุฑุณุงุฆู
3. **ุงูุชูุงุนูุงุช (Reactions)**: ุฅุถุงูุฉ/ุฅุฒุงูุฉ emoji reactions
4. **ุงูุจุญุซ**: ุงูุจุญุซ ูู ุฑุณุงุฆู ุบุฑูุฉ ูุนููุฉ
5. **ุงูุฑุฏูุฏ**: ุฏุนู ูุงูู ููุฑุฏ ุนูู ุงูุฑุณุงุฆู
6. **WebSocket Real-time**: ุฅุดุนุงุฑุงุช ููุฑูุฉ ููุชุญุฏูุซุงุช

---

## ๐ง ุงูุชุญุณููุงุช ุงูุชูููุฉ:

1. **ุงุณุชุจุฏุงู execPopulate**: ุงุณุชุฎุฏุงู `populate([])` ุจุฏูุงู ูู `execPopulate()` (deprecated)
2. **Memory Storage**: ุงุณุชุฎุฏุงู buffer ููุฑูุน ุจุฏูุงู ูู disk storage
3. **Singleton Pattern**: WebSocket server ูู singleton ูุชุฌูุจ ุงูุชูุฑุงุฑ
4. **Error Handling**: ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู ุฌููุน ุงูุฏูุงู
5. **Performance**: ุฅุถุงูุฉ ููุงุฑุณ ูุชุญุณูู ุงูุงุณุชุนูุงูุงุช

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ:

1. **lastLogin**: ููุฌูุฏ ุจุงููุนู ูู `authController.js` ููุชู ุชุญุฏูุซู ุชููุงุฆูุงู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ูุงูุชุณุฌูู
2. **WebSocket Authentication**: ูุฌุจ ุฃู ููุฑุฑ ุงูุนููู token ูู query string: `ws://...?token=...`
3. **File Uploads**: ุงูุขู ูุณุชุฎุฏู memory storageุ ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู MAX_FILE_UPLOAD ูุญุฏุฏ ูู .env
4. **ChatRoom Participants**: ูุฌุจ ุงูุชุฃูุฏ ูู ุฅุถุงูุฉ participants ุนูุฏ ุฅูุดุงุก ุบุฑูุฉ ุดุงุช

---

## ๐งช ูุง ูุฌุจ ุงุฎุชุจุงุฑู:

1. โ ุฅุฑุณุงู ุฑุณุงุฆู ูุน/ุจุฏูู ูุฑููุงุช
2. โ ุงูุฑุฏ ุนูู ุงูุฑุณุงุฆู
3. โ ุฅุถุงูุฉ/ุฅุฒุงูุฉ ุงูุชูุงุนูุงุช
4. โ ุชุนุฏูู ุงูุฑุณุงุฆู
5. โ ุญุฐู ุงูุฑุณุงุฆู
6. โ ุงูุจุญุซ ูู ุงูุฑุณุงุฆู
7. โ WebSocket real-time updates
8. โ ุฅุดุนุงุฑุงุช ุงููุชุงุจุฉ
9. โ ุฅุดุนุงุฑุงุช ุงููุฑุงุกุฉ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ:

- โ `routes/messageRoutes.js` - ุฅุถุงูุฉ ุฌููุน ุงููุณุงุฑุงุช
- โ `models/messageModel.js` - ุฅุถุงูุฉ ุงูุญููู ุงูููููุฏุฉ
- โ `controllers/messageController.js` - ุฅุถุงูุฉ ุงูุฏูุงู ูุฅุตูุงุญุงุช
- โ `websocket/websocket.js` - ุฅููุงู WebSocket server
- โ `app.js` - ุชุญุฏูุซ ุชููุฆุฉ WebSocket

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ**: ${new Date().toLocaleString('ar-SA')}
